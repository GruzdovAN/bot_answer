#!/bin/bash

# üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ø–æ–∏—Å–∫ —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π

echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞"
echo "================================"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f ".env" ]; then
    source .env
    echo "‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω"
else
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π
echo ""
echo "üîç –ü–æ–∏—Å–∫ —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π..."

# –ò—â–µ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
SUSPICIOUS_PATTERNS=(
    "password.*=.*['\"][^'\"]*['\"]"
    "Password.*=.*['\"][^'\"]*['\"]"
    "PASSWORD.*=.*['\"][^'\"]*['\"]"
    "pass.*=.*['\"][^'\"]*['\"]"
    "Pass.*=.*['\"][^'\"]*['\"]"
    "PASS.*=.*['\"][^'\"]*['\"]"
)

FOUND_ISSUES=0

for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
    # –ò—â–µ–º –≤ —Ñ–∞–π–ª–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Å–∫–ª—é—á–∞—è venv, .git, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏)
    RESULTS=$(grep -r -E "$pattern" . --include="*.py" --include="*.yml" --include="*.sh" --include="*.sql" --exclude-dir=venv --exclude-dir=.git --exclude="security_check.sh" --exclude="ENV_SETUP.md" 2>/dev/null | grep -v "os.getenv\|getenv\|System.getenv\|process.env\|MISSING_VARS" || true)
    
    if [ -n "$RESULTS" ]; then
        echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏:"
        echo "$RESULTS"
        FOUND_ISSUES=$((FOUND_ISSUES + 1))
    fi
done

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

ENV_VARS=("DB_PASSWORD" "PGADMIN_PASSWORD" "API_ID_TG" "API_HASH_TG" "BOT_TOKEN")

for var in "${ENV_VARS[@]}"; do
    if [ -z "${!var}" ]; then
        echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è $var –Ω–µ –∑–∞–¥–∞–Ω–∞ –≤ .env"
        FOUND_ISSUES=$((FOUND_ISSUES + 1))
    else
        echo "‚úÖ $var: ${!var:0:10}..."
    fi
done

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ .env
echo ""
echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ .env —Ñ–∞–π–ª—É..."
ENV_PERMS=$(stat -c "%a" .env 2>/dev/null || echo "–Ω–µ –Ω–∞–π–¥–µ–Ω")

if [ "$ENV_PERMS" = "600" ] || [ "$ENV_PERMS" = "640" ]; then
    echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ .env: $ENV_PERMS (–±–µ–∑–æ–ø–∞—Å–Ω–æ)"
else
    echo "‚ö†Ô∏è  –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ .env: $ENV_PERMS (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 600)"
    echo "   –ò—Å–ø—Ä–∞–≤—å—Ç–µ: chmod 600 .env"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º .gitignore
echo ""
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ .gitignore..."
if grep -q "\.env" .gitignore 2>/dev/null; then
    echo "‚úÖ .env —Ñ–∞–π–ª –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ Git"
else
    echo "‚ùå .env —Ñ–∞–π–ª –ù–ï –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ Git!"
    echo "   –î–æ–±–∞–≤—å—Ç–µ –≤ .gitignore: echo '.env' >> .gitignore"
    FOUND_ISSUES=$((FOUND_ISSUES + 1))
fi

# –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "================================"
if [ $FOUND_ISSUES -eq 0 ]; then
    echo "üéâ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "‚úÖ –í—Å–µ –ø–∞—Ä–æ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
    echo "‚úÖ –ù–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π –≤ –∫–æ–¥–µ"
else
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ $FOUND_ISSUES –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
    echo "üîß –ò—Å–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º"
fi

echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:"
echo "   - –†–µ–≥—É–ª—è—Ä–Ω–æ –º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª–∏"
echo "   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ (12+ —Å–∏–º–≤–æ–ª–æ–≤)"
echo "   - –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ .env —Ñ–∞–π–ª –≤ Git"
echo "   - –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ .env —Ñ–∞–π–ª—É"
echo "   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ä–µ–¥"
