# Руководство по использованию LLM команд в CLI

## Обзор

В CLI добавлена новая группа команд `llm` для работы с Large Language Model (DeepSeek) для обработки сообщений из Telegram каналов и извлечения информации о кастингах.

## Доступные команды

### 1. `llm process-message` - Обработка одного сообщения

Обрабатывает одно сообщение через LLM для извлечения информации о кастинге.

**Синтаксис:**
```bash
python cli.py llm process-message -m "ТЕКСТ_СООБЩЕНИЯ" [ОПЦИИ]
```

**Опции:**
- `-m, --message TEXT` - Текст сообщения для обработки (обязательно)
- `--model TEXT` - Модель для обработки (по умолчанию: deepseek-chat)
- `-o, --output TEXT` - Файл для сохранения результата (JSON)
- `-v, --verbose` - Подробный вывод

**Примеры:**
```bash
# Простая обработка
python cli.py llm process-message -m "Кастинг на мужчину 30-40 лет для рекламы"

# С подробным выводом и сохранением в файл
python cli.py llm process-message -m "Кастинг для рекламы. Нужен мужчина 30-40 лет, спортивное телосложение. Женщина 25-35 лет для роли менеджера." -v -o result.json
```

### 2. `llm test` - Тестирование LLM

Запускает тесты LLM с примером сообщения о кастинге.

**Синтаксис:**
```bash
python cli.py llm test [--model MODEL]
```

**Пример:**
```bash
python cli.py llm test
```

### 3. `llm batch-process` - Пакетная обработка

Обрабатывает множество сообщений из файла пакетами.

**Синтаксис:**
```bash
python cli.py llm batch-process -i INPUT_FILE -o OUTPUT_FILE [ОПЦИИ]
```

**Опции:**
- `-i, --input TEXT` - Файл с сообщениями (по одному на строку) (обязательно)
- `-o, --output TEXT` - Файл для сохранения результатов (JSON) (обязательно)
- `--model TEXT` - Модель для обработки (по умолчанию: deepseek-chat)
- `--batch-size INT` - Размер пакета для обработки (по умолчанию: 5)

**Пример:**
```bash
# Создаем файл с сообщениями
echo "Кастинг на мужчину 30-40 лет для рекламы" > messages.txt
echo "Кастинг на сериал. Ищем актеров: мужчина 25-35 лет" >> messages.txt

# Обрабатываем пакетами
python cli.py llm batch-process -i messages.txt -o results.json --batch-size 3
```

### 4. `llm process-recent` - Обработка недавних сообщений

Обрабатывает недавние сообщения из базы данных ClickHouse.

**Синтаксис:**
```bash
python cli.py llm process-recent [ОПЦИИ]
```

**Опции:**
- `--days INT` - Количество дней назад для чтения сообщений (по умолчанию: 1)
- `--limit INT` - Лимит сообщений для обработки (по умолчанию: 10)
- `--model TEXT` - Модель для обработки (по умолчанию: deepseek-chat)
- `-o, --output TEXT` - Файл для сохранения результатов (JSON)

**Пример:**
```bash
# Обработать сообщения за последние 3 дня (максимум 20 сообщений)
python cli.py llm process-recent --days 3 --limit 20 -o recent_results.json
```

## Формат выходных данных

Все команды возвращают JSON с следующей структурой:

```json
{
  "success": true,
  "message_type": "casting_analysis",
  "original_message": "Исходный текст сообщения",
  "model_used": "deepseek-chat",
  "timestamp": "2025-09-17T23:20:30.018044",
  "extracted_data": {
    "message_type": "кастинг",
    "casting_type": "реклама",
    "actors": [
      {
        "gender": "мужчина",
        "age_range": "30-40 лет",
        "role_features": "спортивное телосложение"
      }
    ],
    "has_target_woman": false
  },
  "cost_info": {
    "input_tokens": 534,
    "output_tokens": 100,
    "total_tokens": 634,
    "cache_hit": false,
    "input_cost_usd": 0.000299,
    "output_cost_usd": 0.000168,
    "total_cost_usd": 0.000467
  },
  "error": null
}
```

## Стоимость использования

- **Входные токены**: $0.56 за 1M токенов
- **Выходные токены**: $1.68 за 1M токенов
- **Кэш попадания**: $0.07 за 1M токенов (входные)

Примерная стоимость обработки одного сообщения: $0.0003-0.001

## Требования

1. Установленные зависимости из `requirements.txt`
2. Настроенный API ключ DeepSeek в файле `.env`:
   ```
   DEEPSEEK_API_KEY=your_api_key_here
   ```
3. Активированное виртуальное окружение

## Логирование

Все операции логируются с уровнем INFO. Логи включают:
- Время начала и завершения обработки
- Количество обработанных токенов
- Стоимость обработки
- Ошибки и предупреждения

## Обработка ошибок

- Если модель не может извлечь информацию о кастинге, `success` будет `false`
- Ошибки API записываются в поле `error`
- Пакетная обработка продолжается даже при ошибках отдельных сообщений
