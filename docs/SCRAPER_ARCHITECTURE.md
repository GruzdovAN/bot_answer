# Архитектура системы сбора данных из @datasciencejobs

## Схема компонентов

```
┌─────────────────────────────────────────────────────────────────┐
│                        TELEGRAM CHANNEL                        │
│                    @datasciencejobs                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Message 1: "Senior Python Developer at Google"        │   │
│  │  Message 2: "Data Scientist Remote Position"           │   │
│  │  Message 3: "ML Engineer #python #tensorflow"          │   │
│  │  ... (1000+ messages за месяц)                         │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PYTHON SCRAPER                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  TelegramClient (Telethon)                             │   │
│  │  ├─ Подключение к API                                  │   │
│  │  ├─ Получение сообщений                                │   │
│  │  └─ Rate limiting                                      │   │
│  │                                                         │   │
│  │  MessageParser                                         │   │
│  │  ├─ Извлечение текста                                  │   │
│  │  ├─ Парсинг хештегов (#python, #ml)                   │   │
│  │  ├─ Извлечение упоминаний (@company)                  │   │
│  │  ├─ Поиск ссылок (job boards)                         │   │
│  │  └─ Анализ реакций (лайки, репосты)                   │   │
│  │                                                         │   │
│  │  DataProcessor                                         │   │
│  │  ├─ Классификация вакансий                             │   │
│  │  ├─ Извлечение технологий                              │   │
│  │  ├─ Определение уровня (junior/senior)                 │   │
│  │  └─ Batch группировка                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CLICKHOUSE DATABASE                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Table: datascience_jobs                               │   │
│  │  ├─ message_id (UInt64)                               │   │
│  │  ├─ date (DateTime)                                   │   │
│  │  ├─ text (String)                                     │   │
│  │  ├─ hashtags (Array(String))                          │   │
│  │  ├─ mentions (Array(String))                          │   │
│  │  ├─ links (Array(String))                             │   │
│  │  ├─ views (UInt32)                                    │   │
│  │  ├─ reactions (Map(String, UInt32))                   │   │
│  │  └─ created_at (DateTime)                             │   │
│  │                                                         │   │
│  │  Engine: MergeTree                                     │   │
│  │  Partition: by month                                   │   │
│  │  Order: (date, message_id)                            │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ANALYTICS & MONITORING                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Dashboard                                             │   │
│  │  ├─ Количество сообщений                               │   │
│  │  ├─ Топ технологии (#python, #tensorflow)             │   │
│  │  ├─ Тренды по времени                                  │   │
│  │  └─ География вакансий                                 │   │
│  │                                                         │   │
│  │  Alerts                                                │   │
│  │  ├─ Ошибки парсинга >5%                               │   │
│  │  ├─ Время выполнения >2ч                              │   │
│  │  └─ Отсутствие данных >24ч                            │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Инициализация
```
Start → Load Config → Connect to Telegram → Connect to ClickHouse
```

### 2. Сбор данных
```
Get Channel → Fetch Messages → Parse Message → Extract Entities → Batch Data
```

### 3. Сохранение
```
Batch Data → Insert to ClickHouse → Log Statistics → Update Progress
```

### 4. Мониторинг
```
Check Status → Generate Reports → Send Alerts → Update Dashboard
```

## Структура данных

### Входные данные (Telegram Message)
```json
{
  "id": 12345,
  "date": "2024-09-15T10:30:00Z",
  "message": "Senior Python Developer at Google. Remote work. #python #ml #tensorflow @google",
  "views": 1500,
  "forwards": 25,
  "replies": 8,
  "reactions": {"👍": 45, "❤️": 12},
  "media": null
}
```

### Выходные данные (ClickHouse Record)
```json
{
  "message_id": 12345,
  "channel_id": -1001234567890,
  "channel_username": "@datasciencejobs",
  "date": "2024-09-15T10:30:00Z",
  "text": "Senior Python Developer at Google. Remote work. #python #ml #tensorflow @google",
  "views": 1500,
  "forwards": 25,
  "replies": 8,
  "reactions": {"👍": 45, "❤️": 12},
  "media_type": null,
  "media_url": null,
  "hashtags": ["#python", "#ml", "#tensorflow"],
  "mentions": ["@google"],
  "links": [],
  "created_at": "2024-09-16T20:55:00Z"
}
```

## Технические детали

### Производительность
- **Скорость обработки:** 100-200 сообщений/минуту
- **Batch размер:** 1000 сообщений
- **Время выполнения:** 30-60 минут для месяца данных
- **Использование памяти:** <500MB

### Надежность
- **Retry логика:** 3 попытки для каждого запроса
- **Rate limiting:** 1 секунда между запросами
- **Error handling:** Логирование всех ошибок
- **Progress tracking:** Сохранение прогресса

### Масштабируемость
- **Горизонтальное:** Возможность запуска нескольких инстансов
- **Вертикальное:** Увеличение batch размера
- **Партиционирование:** По месяцам в ClickHouse
- **Кэширование:** Кэш для повторных запросов

## Безопасность

### API ключи
- Хранение в .env файле
- Права доступа 600
- Ротация ключей

### Данные
- Шифрование в transit
- Анонимизация при необходимости
- Соблюдение GDPR

### Мониторинг
- Логирование всех операций
- Алерты на подозрительную активность
- Аудит доступа к данным
